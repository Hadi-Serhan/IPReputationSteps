name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with coverage (>= 90%) + Allure results
        run: |
          pytest -q \
            --alluredir=allure-results \
            --cov=check_ip \
            --cov=check_ip_batch \
            --cov=common \
            --cov-report=term-missing \
            --cov-fail-under=90
      
      - name: Write Allure environment info
        if: always()
        run: |
          python - <<'PY'
          import os, platform, sys
          from pathlib import Path

          p = Path("allure-results")
          p.mkdir(exist_ok=True)

          env = {
            "OS": platform.platform(),
            "Python": sys.version.replace("\n", " "),
            "Repo": os.getenv("GITHUB_REPOSITORY", ""),
            "Ref": os.getenv("GITHUB_REF_NAME", ""),
            "SHA": os.getenv("GITHUB_SHA", ""),
            "RunID": os.getenv("GITHUB_RUN_ID", ""),
          }

          (p / "environment.properties").write_text(
            "\n".join(f"{k}={v}" for k, v in env.items()) + "\n",
            encoding="utf-8",
          )
          PY

      - name: Upload Allure results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results
          retention-days: 7

  allure-pages:
    name: Publish Allure Report (GitHub Pages)
    runs-on: ubuntu-latest
    needs: test
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      pages: write
      id-token: write
      contents: read

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download allure-results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Set up Java (Allure CLI requires Java)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Allure CLI
        run: |
          npm install -g allure-commandline
          allure --version

      - name: Generate Allure HTML report
        run: |
          allure generate allure-results -o allure-report --clean

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      
  docker:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build check-ip image
        run: docker build --target check-ip -t check-ip .

      - name: Build check-ip-batch image
        run: docker build --target check-ip-batch -t check-ip-batch .

      - name: Smoke test check-ip (expected failure - missing key)
        run: |
          set +e
          out=$(docker run --rm -e IP_ADDRESS="8.8.8.8" check-ip)
          code=$?
          set -e

          echo "$out" | jq .

          test "$code" -eq 2
          test "$(echo "$out" | jq -r '.step_status.code')" -eq 2

      - name: Smoke test check-ip-batch (expected failure - missing key)
        run: |
          set +e
          out=$(docker run --rm -e IP_ADDRESSES="8.8.8.8,invalid-ip" check-ip-batch)
          code=$?
          set -e

          echo "$out" | jq .

          test "$code" -eq 2
          test "$(echo "$out" | jq -r '.step_status.code')" -eq 2